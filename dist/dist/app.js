angular.module("chApp",["ngRoute","ngAnimate","ngDraggable"]).value("mapProxy",{map:void 0,routeGroup:new H.map.Group,group:new H.map.Group,startPos:{lng:13.4,lat:52.51},currentPos:void 0,zoom:15}).value("lang",{de:{queryPlaceHolder:"Ort oder Adresse",resultError:"Ups, das hÃ¤tte nicht passieren sollen",subHeader:"Eine kleine Routing-Anwendung"},en:{queryPlaceHolder:"Place or address",resultError:"Argh, that should not have happened",subHeader:"A small routing application"}}).value("waypoints",{list:[]}).constant("APP_ID","K8Vpg17foNbs5R8PBNj0").constant("APP_CODE","kmjqZuHcHrJ6wUGDM4PZ-w"),angular.module("chApp").config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"../app/templates/app.html"}).otherwise({redirectTo:"/"})}]),angular.module("chApp").controller("AppController",["$scope","lang","$http","mapProxy","UrlFactory","waypoints","MapFactory","$q",function($scope,lang,$http,mapProxy,UrlFactory,waypoints,MapFactory,$q){var browserLang=navigator.language||navigator.userLanguage||"en",langShort=browserLang.split("-")[0].toLowerCase(),langObject=lang[langShort]||lang.en;$scope.langCode=langShort,$scope.lang=langObject,$scope.places=[],$scope.error=!1,$scope.fetchPlaces=function(){if(this.search){var loc=mapProxy.map.getCenter();$q.all([$http.get(UrlFactory.getExploreUrl(loc,this.search)),$http.get(UrlFactory.getSearchUrl(this.search.replace(/\s+/g,"+")))]).then(function(responses){if($scope.error=!1,$scope.emptyPlaces(),responses[0]&&responses[0].data&&responses[0].data.results&&responses[0].data.results.items&&Array.prototype.push.apply($scope.places,resps),responses[1]&&responses[1].data&&responses[1].data.Response&&responses[1].data.Response.View&&responses[1].data.Response.View[0]&&responses[1].data.Response.View[0].Result){var resps=responses[1].data.Response.View[0].Result.map(function(item){return{title:item.Location.Address.Label,position:[item.Location.DisplayPosition.Latitude,item.Location.DisplayPosition.Longitude]}});Array.prototype.push.apply($scope.places,resps)}},function(){$scope.error=!0})}},$scope.emptyPlaces=function(){$scope.places.splice(0,$scope.places.length)},$scope.clearPlaces=function(){$scope.emptyPlaces(),$scope.search="",MapFactory.placeMarker()},$scope.putMarker=function(){var pos={lat:this.place.position[0],lng:this.place.position[1]};MapFactory.placeMarker(pos)},$scope.addToList=function(){waypoints.list.push(this.place),$scope.places=[],$scope.search="",mapProxy.group.removeAll()}}]).controller("ListController",["$scope","waypoints",function($scope,waypoints){$scope.list=waypoints.list,$scope.removeFromList=function(item){var index=this.list.indexOf(item);index>-1&&this.list.splice(index,1)},$scope.moveInList=function(item,offset){var index=this.list.indexOf(item),newIndex=index+offset;newIndex>-1&&newIndex<this.list.length&&(this.removeFromList(item),this.list.splice(newIndex,0,item))},$scope.moveBefore=function(index,item,evt){this.removeFromList(item),this.list.splice(index,0,item)}}]).controller("RouterController",["$scope","waypoints","mapProxy","RouterParameterFactory","$http","RouterFactory","PlatformService","MapFactory",function($scope,waypoints,mapProxy,RouterParameterFactory,$http,RouterFactory,PlatformService,MapFactory){$scope.list=waypoints.list,$scope.mode="car",$scope.distance="0m",$scope.duration="0s",$scope.formatValues=function(_distance,_duration){var result=[],distance=parseInt(_distance),duration=parseInt(_duration),h=Math.floor(duration/3600);duration-=3600*h;var min=Math.floor(duration/60);duration-=60*min,result.push(h+"h "+min+"min "+duration+"s");var km=Math.floor(distance/1e3);return distance-=1e3*km,result.push(km+"km "+distance+"m"),result},$scope.toggleMode=function(mode){this.mode=mode},$scope.clearList=function(){this.list.splice(0,$scope.list.length),$scope.distance="0m",$scope.duration="0s",MapFactory.moveTo(mapProxy.startPos,mapProxy.zoom)};var handleChange=function(){if($scope.list.length>1){mapProxy.router||(mapProxy.router=PlatformService.getRoutingService());var params=RouterParameterFactory.getRoute(waypoints.list,$scope.mode),reject=function(){},resolve=function(result){if(result.response&&result.response.route){var route=result.response.route[0],summary=route.leg.reduce(function(memo,leg){return memo.distance+=leg.summary.distance,memo.travelTime+=leg.summary.travelTime,memo},{distance:0,travelTime:0});$scope.distance=summary.distance,$scope.duration=summary.travelTime,RouterFactory.drawRoute(route),$scope.$apply()}else $scope.distance=0,$scope.duration=0,RouterFactory.clearRoute(),$scope.$apply()};mapProxy.router.calculateRoute(params,resolve,reject)}else RouterFactory.clearRoute()};$scope.$watch("mode",handleChange),$scope.$watch(function(){return waypoints.list},handleChange,!0)}]),angular.module("chApp").directive("mapContainer",["PlatformService","mapProxy","MapFactory","$window",function(PlatformService,mapProxy,MapFactory,$window){return{link:function(scope,elem,attr,ctrl){var width=elem[0].offsetWidth;angular.element($window).bind("resize",function(){var newWidth=elem[0].offsetWidth;width!=newWidth&&(console.log("resizing now"),width=newWidth,MapFactory.resizeMap())});var defaultLayers=PlatformService.createDefaultLayers();mapProxy.map=new H.Map(elem[0],defaultLayers.normal.map),mapProxy.map.addObject(mapProxy.group),mapProxy.map.addObject(mapProxy.routeGroup),MapFactory.moveTo(mapProxy.startPos,mapProxy.zoom),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(pos){mapProxy.startPos={lng:pos.coords.longitude,lat:pos.coords.latitude},MapFactory.placeMarker()})}}}]),angular.module("chApp").factory("UrlFactory",["APP_ID","APP_CODE",function(app_id,app_code){var placesBaseUrl="http://places.cit.api.here.com/places/v1/",searchBaseUrl="http://geocoder.api.here.com/6.2/";return{getExploreUrl:function(pos,q){return[placesBaseUrl+"discover/explore?app_id="+app_id,"app_code="+app_code,"at="+pos.lat+","+pos.lng,"q="+q].join("&")},getSearchUrl:function(q){return[searchBaseUrl+"geocode.json?app_id="+app_id,"app_code="+app_code,"gen=8","searchtext="+q].join("&")}}}]).factory("MapFactory",["mapProxy","QueueService","$q",function(mapProxy,Queue,$q){function placeMarker(pos){var myPos=pos||mapProxy.startPos,marker=new H.map.Marker(myPos);mapProxy.group.removeAll(),mapProxy.group.addObject(marker),this.moveTo(myPos,mapProxy.zoom)}function moveTo(pos,zoom){var myPos=pos||mapProxy.startPos;Queue.add(function(resolve){mapProxy.map.setCenter(myPos,!0),mapProxy.map.addEventListener("mapviewchangeend",function(){this.removeEventListener("mapviewchangeend"),resolve()})}).add(function(resolve){mapProxy.map.setZoom(zoom,!0),mapProxy.map.addEventListener("mapviewchangeend",function(){this.removeEventListener("mapviewchangeend"),resolve()})})}var resizeMap=function(){mapProxy.map.getViewPort().resize()};return{placeMarker:placeMarker,moveTo:moveTo,resizeMap:resizeMap}}]).factory("RouterParameterFactory",[function(){function getRoute(waypoints,mode){var params={mode:"fastest;"+mode,representation:"display",legattributes:"summary"};if(!waypoints.length)return-1;var last,i=0,j=0;do{var waypoint=waypoints[i++],current="geo!"+waypoint.position[0]+","+waypoint.position[1];last!=current&&(params["waypoint"+j]=current,last=current,j++)}while(i<waypoints.length);return params.waypoint1?params:-1}return{getRoute:getRoute}}]).factory("RouterFactory",["mapProxy","QueueService",function(mapProxy,Queue){var drawRoute=function(route){var routeShape=route.shape,strip=new H.geo.Strip;routeShape.forEach(function(point){var parts=point.split(",");strip.pushLatLngAlt(parts[0],parts[1])});var routeLine=new H.map.Polyline(strip,{style:{strokeColor:"blue",lineWidth:5}});mapProxy.routeGroup.removeAll(),mapProxy.routeGroup.addObject(routeLine),Queue.add(function(resolve){mapProxy.map.setViewBounds(routeLine.getBounds(),!0),mapProxy.map.addEventListener("mapviewchangeend",function(){this.removeEventListener("mapviewchangeend"),resolve()})})},clearRoute=function(){mapProxy.routeGroup.removeAll()};return{drawRoute:drawRoute,clearRoute:clearRoute}}]),angular.module("chApp").service("PlatformService",["APP_ID","APP_CODE","mapProxy",function(app_id,app_code,mapProxy){return new H.service.Platform({app_id:app_id,app_code:app_code})}]).service("QueueService",function(){var arr=[],current=null,add=function(def){return arr.push(def),current||start(),this},start=function(){current=arr.shift(),current&&current(start)};return{add:add}}),angular.module("templates-dist",["../app/templates/app.html"]),angular.module("../app/templates/app.html",[]).run(["$templateCache",function($templateCache){$templateCache.put("../app/templates/app.html",'<div class="page-header"></div>\n<div class="page-header second"></div>\n<div class="app" ng-controller="AppController">\n	<div class="page-header">\n		<h1>ChallengeApp<small>{{lang.subHeader}}</small></h1>\n	</div>\n	<div class="wrapper"><!--\n		--><div class="search input-group">\n			<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>\n			<input type="text" class="form-control" ng-model="search" ng-model-options="{debounce: 500}" placeholder="{{lang.queryPlaceHolder}}" ng-change="fetchPlaces()">\n			<span class="input-group-btn">\n				<button class="btn btn-default" type="button" ng-click="clearPlaces()"><i class="glyphicon glyphicon-remove"></i></button>\n			</span>\n		</div><!--\n		--><div class="list">\n			<div class="results">\n				<div class="place spacer"></div>\n				<div class="loader alert alert-info" ng-show="search.length && !places.length && !error">\n					<i class="fa fa-spinner fa-spin"></i>\n				</div>\n				<div class="error alert alert-danger" ng-show="search.length && error">\n					<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>\n					{{lang.resultError}}\n				</div>\n				<div ng-repeat="place in places | orderBy:title" ng-show="search.length" class="place btn-group">\n					<button type="button" class="btn text-btn btn-default" ng-click="putMarker()">{{place.title}}</button>\n					<button type="button" class="btn add-btn btn-default" ng-click="addToList()">\n						<span class="glyphicon glyphicon-plus"></span>\n					</button>\n				</div>\n				<div class="place spacer"></div>\n			</div>\n			<div class="waypoints {{search.length ? \'ng-hide\' : \'\'}}" ng-controller="ListController">\n				<div class="place spacer"></div>\n				<div ng-repeat="place in list track by $index" class="droparea" ng-drop="true" ng-drop-success="moveBefore($index, $data, $event)">\n					<div class="place btn-group" ng-drag="true" ng-drag-data="place">\n						<span class="input-group-addon text">{{$index + 1 + ". " + place.title}}</span>\n						<button type="button" class="btn text-btn btn-default" ng-click="moveInList(place, -1)">\n							<span class="glyphicon glyphicon-chevron-up"></span>\n						</button>\n						<button type="button" class="btn text-btn btn-default" ng-click="moveInList(place, 1)">\n							<span class="glyphicon glyphicon-chevron-down"></span>\n						</button>\n						<button type="button" class="btn text-btn btn-warning" ng-click="removeFromList(place)">\n							<span class="glyphicon glyphicon-trash"></span>\n						</button>\n					</div>\n				</div>\n				<div class="place spacer"></div>\n			</div>\n		</div><!--\n		--><div class="routedetails" ng-controller="RouterController">\n			<div class="place btn-group">\n				<span class="input-group-addon text">{{formatValues(distance, duration).join(" ")}}</span>\n'+"				<button type=\"button\" class=\"btn text-btn {{mode=='car' ? 'btn-default':''}} {{list.length < 2 ? 'disabled' : ''}}\" ng-click=\"toggleMode('car')\">\n					<span class=\"fa fa-car\"></span>\n				</button>\n				<button type=\"button\" class=\"btn text-btn {{mode=='pedestrian' ? 'btn-default':''}} {{list.length < 2 ? 'disabled' : ''}}\" ng-click=\"toggleMode('pedestrian')\">\n					<span class=\"fa fa-male\"></span>\n				</button>\n				<button type=\"button\" class=\"btn text-btn {{mode=='publicTransport' ? 'btn-default':''}} {{list.length < 2 ? 'disabled' : ''}}\" ng-click=\"toggleMode('publicTransport')\">\n					<span class=\"fa fa-bus\"></span>\n				</button>\n				<button type=\"button\" class=\"btn text-btn btn-warning {{list.length < 2 ? 'disabled' : ''}}\" ng-click=\"clearList()\">\n					<span class=\"glyphicon glyphicon-trash\"></span>\n				</button>\n			</div>\n		</div><!--\n		--><div class=\"map\" map-container></div><!--\n	--></div>\n</div>\n")}]);